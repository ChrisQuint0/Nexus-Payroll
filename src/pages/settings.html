<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings | Nexus Payroll</title>
    <link rel="stylesheet" href="../output.css" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="../assets/npayroll_logo.png"
    />
    <link rel="stylesheet" href="../css/ag-grid/ag-theme-quartz.css" />
  </head>

  <body class="flex bg-base-200 min-h-screen">
    <!-- Add this to each protected page -->
    <script type="module">
      import { checkPageAccess } from "../js/utils/pageProtection.js";

      // Check access immediately when page loads
      checkPageAccess();
    </script>

    <!-- Sidebar placeholder -->
    <div id="sidebar"></div>

    <!-- Main Content -->
    <main class="flex-1 p-8 space-y-6">
      <div class="space-y-1">
        <h1 class="text-4xl font-medium">Settings</h1>
      </div>

      <!-- Tabs Container -->
      <div class="bg-base-100 p-6 rounded-2xl shadow-lg">
        <!-- Tab Navigation -->
        <div
          role="tablist"
          class="tabs tabs-boxed mb-6 bg-base-200/60 p-1 gap-0.5"
        >
          <a
            role="tab"
            class="tab tab-active font-medium text-sm"
            data-tab="company-details"
            >Company Details</a
          >
          <a role="tab" class="tab font-medium text-sm" data-tab="departments"
            >Departments</a
          >
          <a role="tab" class="tab font-medium text-sm" data-tab="positions"
            >Positions</a
          >
          <a role="tab" class="tab font-medium text-sm" data-tab="schedules"
            >Work Schedules</a
          >
          <a role="tab" class="tab font-medium text-sm" data-tab="cutoff"
            >Cutoff Periods</a
          >
          <a role="tab" class="tab font-medium text-sm" data-tab="deductions"
            >Deductions</a
          >
        </div>

        <!-- Tab Content -->
        <div class="tab-content-container">
          <!-- Company Details -->
          <div id="tab-content-company-details" class="">
            <div class="card bg-base-100 shadow-xl">
              <div class="card-body">
                <h2 class="card-title text-xl mb-4">Company Profile</h2>

                <form id="companyDetailsForm" class="space-y-6">
                  <input type="hidden" id="companyId" name="companyId" />

                  <div
                    class="flex flex-col items-start gap-4 p-4 border border-base-300 rounded-lg"
                  >
                    <p class="font-semibold">Current Logo</p>
                    <img
                      id="currentLogo"
                      src="https://placehold.co/100x100/9b97ef/FFFFFF/png?text=CN"
                      alt="Current Company Logo"
                      class="w-24 h-24 object-cover rounded-full border-2 border-primary"
                    />

                    <div class="w-full">
                      <label class="label">
                        <span class="label-text"
                          >Update Logo (500x500 PNG required)</span
                        >
                      </label>
                      <input
                        id="logoUpload"
                        name="logoUpload"
                        type="file"
                        accept="image/png"
                        class="file-input file-input-bordered file-input-primary w-full max-w-xs"
                      />
                      <p class="text-xs text-warning mt-2">
                        Uploading a new logo will delete the previous one upon
                        saving.
                      </p>
                    </div>
                  </div>

                  <label class="form-control w-full">
                    <div class="label">
                      <span class="label-text font-semibold">Company Name</span>
                    </div>
                    <input
                      id="companyName"
                      name="companyName"
                      type="text"
                      placeholder="Nexus Payroll"
                      class="input input-bordered w-full"
                      required
                    />
                  </label>

                  <label class="form-control w-full">
                    <div class="label">
                      <span class="label-text font-semibold"
                        >Company Address</span
                      >
                    </div>
                    <textarea
                      id="companyAddress"
                      name="companyAddress"
                      placeholder="01 Conching St. Buting Pasig City"
                      class="textarea textarea-bordered h-24 w-full"
                      required
                    ></textarea>
                  </label>

                  <div class="card-actions justify-end pt-4">
                    <button
                      type="submit"
                      id="saveDetailsBtn"
                      class="btn btn-primary btn-lg"
                    >
                      <span id="saveDetailsBtnText">Save Changes</span>
                      <span
                        id="loadingSpinner"
                        class="loading loading-spinner hidden"
                      ></span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div id="departments" class="tab-content"></div>

          <!-- Departments Tab -->
          <div id="tab-content-departments" class="hidden">
            <div class="flex flex-col gap-4">
              <div class="flex flex-wrap justify-between items-center gap-3">
                <button
                  onclick="openDepartmentModal()"
                  class="btn btn-primary h-10 min-h-0 px-5 text-sm font-semibold"
                >
                  Add Department
                </button>
                <input
                  id="searchDepartments"
                  type="search"
                  placeholder="Search departments..."
                  class="input input-bordered w-52 h-10 text-sm focus:input-primary"
                />
              </div>

              <div
                id="departmentsGrid"
                class="h-[470px] w-full ag-theme-quartz rounded-lg"
              ></div>
            </div>
          </div>

          <!-- Positions Tab -->
          <div id="tab-content-positions" class="hidden">
            <div class="flex flex-col gap-4">
              <div class="flex flex-wrap justify-between items-center gap-3">
                <button
                  onclick="openPositionModal()"
                  class="btn btn-primary h-10 min-h-0 px-5 text-sm font-semibold"
                >
                  Add Position
                </button>
                <input
                  id="searchPositions"
                  type="search"
                  placeholder="Search positions..."
                  class="input input-bordered w-52 h-10 text-sm focus:input-primary"
                />
              </div>

              <div
                id="positionsGrid"
                class="h-[470px] w-full ag-theme-quartz rounded-lg"
              ></div>
            </div>
          </div>

          <!-- Work Schedules Tab -->
          <div id="tab-content-schedules" class="hidden">
            <div class="flex flex-col gap-4">
              <div class="flex flex-wrap justify-between items-center gap-3">
                <button
                  onclick="openScheduleModal()"
                  class="btn btn-primary h-10 min-h-0 px-5 text-sm font-semibold"
                >
                  Add Schedule
                </button>
                <input
                  id="searchOfficialTime"
                  type="search"
                  placeholder="Search schedules..."
                  class="input input-bordered w-52 h-10 text-sm focus:input-primary"
                />
              </div>

              <div
                id="officialTimeGrid"
                class="h-[470px] w-full ag-theme-quartz rounded-lg"
              ></div>
            </div>
          </div>

          <!-- Cutoff Periods Tab -->
          <div id="tab-content-cutoff" class="hidden">
            <div class="flex flex-col gap-4">
              <div class="flex flex-wrap justify-between items-center gap-3">
                <button
                  onclick="window.openCutoffModal()"
                  class="btn btn-primary h-10 min-h-0 px-5 text-sm font-semibold"
                >
                  Add Cutoff Period
                </button>
                <input
                  id="searchCutoff"
                  type="search"
                  placeholder="Search cutoff periods..."
                  class="input input-bordered w-52 h-10 text-sm focus:input-primary"
                />
              </div>

              <div
                id="cutoffGrid"
                class="h-[470px] w-full ag-theme-quartz rounded-lg"
              ></div>
            </div>
          </div>

          <!-- Deductions Tab -->
          <div id="tab-content-deductions" class="hidden">
            <div class="card bg-base-100 shadow-lg p-8 max-w-4xl">
              <div class="mb-6">
                <h2 class="text-xl font-bold text-base-content">
                  Deduction Rates
                </h2>
                <p class="text-sm text-base-content/60 mt-1">
                  Configure standard deduction percentages for payroll
                  calculations
                </p>
              </div>

              <button
                onclick="window.openDeductionsModal()"
                class="btn btn-primary h-10 min-h-0 w-full md:w-auto px-6 text-sm font-semibold mb-6"
              >
                Edit Deduction Rates
              </button>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="form-control">
                  <label class="label pb-1.5">
                    <span class="label-text font-semibold text-sm"
                      >SSS Employee Contribution (%)</span
                    >
                  </label>
                  <div
                    class="text-2xl font-bold text-primary"
                    id="currentSSSRate"
                  >
                    -
                  </div>
                  <p class="text-xs text-base-content/60 mt-1">
                    Standard: 5% (Employer: 10%)
                  </p>
                </div>

                <div class="form-control">
                  <label class="label pb-1.5">
                    <span class="label-text font-semibold text-sm"
                      >PhilHealth Employee Contribution (%)</span
                    >
                  </label>
                  <div
                    class="text-2xl font-bold text-primary"
                    id="currentPhilHealthRate"
                  >
                    -
                  </div>
                  <p class="text-xs text-base-content/60 mt-1">
                    Standard: 2.5% (Employer: 2.5%)
                  </p>
                </div>

                <div class="form-control">
                  <label class="label pb-1.5">
                    <span class="label-text font-semibold text-sm"
                      >Pag-IBIG Employee Contribution (%)</span
                    >
                  </label>
                  <div
                    class="text-2xl font-bold text-primary"
                    id="currentPagIBIGRate"
                  >
                    -
                  </div>
                  <p class="text-xs text-base-content/60 mt-1">
                    Standard: 2% (Employer: 2%)
                  </p>
                </div>
              </div>

              <div class="alert bg-info/10 border border-info/30">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  class="stroke-info shrink-0 w-5 h-5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
                <div>
                  <h3 class="font-semibold text-sm">Important Information</h3>
                  <p class="text-sm mt-0.5">
                    These rates will be applied to all new payroll calculations.
                    Changes will not affect previously calculated payslips.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Department Modal -->
    <dialog id="departmentModal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Add Department</h3>
        <form id="addDepartmentForm" method="dialog">
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm"
                >Department Name</span
              ></label
            >
            <input
              type="text"
              id="departmentName"
              class="input input-bordered w-full h-10 text-sm focus:input-primary"
              placeholder="e.g., Information Technology"
              required
            />
          </div>
          <div class="modal-action">
            <button
              type="button"
              onclick="closeDepartmentModal()"
              class="btn btn-ghost h-10 min-h-0 px-5 text-sm"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary h-10 min-h-0 px-5 text-sm font-semibold"
            >
              Add Department
            </button>
          </div>
        </form>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Position Modal -->
    <dialog id="positionModal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Add Position</h3>
        <form id="addPositionForm" method="dialog">
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm"
                >Position Name</span
              ></label
            >
            <input
              type="text"
              id="positionName"
              class="input input-bordered w-full h-10 text-sm focus:input-primary"
              placeholder="e.g., Software Engineer"
              required
            />
          </div>
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm"
                >Department</span
              ></label
            >
            <select
              id="positionDepartment"
              class="select select-bordered w-full h-10 text-sm focus:select-primary"
              required
            >
              <option value="" disabled selected>Select department</option>
            </select>
          </div>
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm">Rank</span></label
            >
            <input
              type="number"
              id="positionRank"
              class="input input-bordered w-full h-10 text-sm focus:input-primary"
              placeholder="e.g., 1 (higher number = higher rank)"
              min="1"
              required
            />
            <label class="label">
              <span class="label-text-alt text-base-content/60"
                >Higher numbers indicate higher positions in hierarchy</span
              >
            </label>
          </div>
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm"
                >Base Salary (â‚±)</span
              ></label
            >
            <input
              type="number"
              id="positionSalary"
              class="input input-bordered w-full h-10 text-sm focus:input-primary"
              placeholder="30000"
              step="0.01"
              min="0"
              required
            />
          </div>
          <div class="modal-action">
            <button
              type="button"
              onclick="closePositionModal()"
              class="btn btn-ghost h-10 min-h-0 px-5 text-sm"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary h-10 min-h-0 px-5 text-sm font-semibold"
            >
              Add Position
            </button>
          </div>
        </form>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Schedule Modal -->
    <dialog id="scheduleModal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Add Work Schedule</h3>
        <form id="addOfficialTimeForm" method="dialog">
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm"
                >Schedule Name</span
              ></label
            >
            <input
              type="text"
              id="scheduleName"
              class="input input-bordered w-full h-10 text-sm focus:input-primary"
              placeholder="e.g., Regular Day Shift"
              required
            />
          </div>
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm"
                >Start Time</span
              ></label
            >
            <input
              type="time"
              id="startTime"
              class="input input-bordered w-full h-10 text-sm focus:input-primary"
              required
            />
          </div>
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm"
                >End Time</span
              ></label
            >
            <input
              type="time"
              id="endTime"
              class="input input-bordered w-full h-10 text-sm focus:input-primary"
              required
            />
          </div>
          <div class="modal-action">
            <button
              type="button"
              onclick="closeScheduleModal()"
              class="btn btn-ghost h-10 min-h-0 px-5 text-sm"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary h-10 min-h-0 px-5 text-sm font-semibold"
            >
              Add Schedule
            </button>
          </div>
        </form>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Cutoff Modal -->
    <dialog id="cutoffModal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Add Cutoff Period</h3>
        <form id="addCutoffForm" method="dialog">
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm"
                >Start Date</span
              ></label
            >
            <input
              type="date"
              id="cutoffStartDate"
              class="input input-bordered w-full h-10 text-sm focus:input-primary"
              required
            />
          </div>
          <div class="form-control mb-4">
            <label class="label pb-1.5"
              ><span class="label-text font-semibold text-sm"
                >End Date</span
              ></label
            >
            <input
              type="date"
              id="cutoffEndDate"
              class="input input-bordered w-full h-10 text-sm focus:input-primary"
              required
            />
          </div>
          <div class="modal-action">
            <button
              type="button"
              onclick="window.closeCutoffModal()"
              class="btn btn-ghost h-10 min-h-0 px-5 text-sm"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary h-10 min-h-0 px-5 text-sm font-semibold"
            >
              Add Cutoff Period
            </button>
          </div>
        </form>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Deductions Modal -->
    <dialog id="deductionsModal" class="modal">
      <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4">Edit Deduction Rates</h3>
        <form id="deductionsForm" method="dialog">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="form-control">
              <label class="label pb-1.5">
                <span class="label-text font-semibold text-sm"
                  >SSS Employee (%)</span
                >
              </label>
              <input
                type="number"
                id="sssInput"
                class="input input-bordered w-full h-10 text-sm focus:input-primary"
                placeholder="5.00"
                step="0.01"
                min="0"
                max="100"
                required
              />
            </div>

            <div class="form-control">
              <label class="label pb-1.5">
                <span class="label-text font-semibold text-sm"
                  >PhilHealth Employee (%)</span
                >
              </label>
              <input
                type="number"
                id="philhealthInput"
                class="input input-bordered w-full h-10 text-sm focus:input-primary"
                placeholder="2.50"
                step="0.01"
                min="0"
                max="100"
                required
              />
            </div>

            <div class="form-control">
              <label class="label pb-1.5">
                <span class="label-text font-semibold text-sm"
                  >Pag-IBIG Employee (%)</span
                >
              </label>
              <input
                type="number"
                id="pagibigInput"
                class="input input-bordered w-full h-10 text-sm focus:input-primary"
                placeholder="2.00"
                step="0.01"
                min="0"
                max="100"
                required
              />
            </div>
          </div>

          <div class="alert alert-warning mb-6">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="stroke-current shrink-0 h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              />
            </svg>
            <span class="text-sm"
              >Changes will apply to new payroll calculations only.</span
            >
          </div>

          <div class="modal-action">
            <button
              type="button"
              onclick="window.closeDeductionsModal()"
              class="btn btn-ghost h-10 min-h-0 px-5 text-sm"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="btn btn-primary h-10 min-h-0 px-5 text-sm font-semibold"
            >
              Save Changes
            </button>
          </div>
        </form>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <script>
      // Modal Functions
      function openDepartmentModal() {
        document.getElementById("departmentModal").showModal();
      }
      function closeDepartmentModal() {
        document.getElementById("departmentModal").close();
      }

      function openPositionModal() {
        // Load departments into dropdown before opening
        if (window.loadDepartmentsIntoDropdown) {
          window.loadDepartmentsIntoDropdown();
        }
        document.getElementById("positionModal").showModal();
      }
      function closePositionModal() {
        document.getElementById("positionModal").close();
      }

      function openScheduleModal() {
        document.getElementById("scheduleModal").showModal();
      }
      function closeScheduleModal() {
        document.getElementById("scheduleModal").close();
      }

      // Expose cutoff modal functions globally
      window.openCutoffModal = function () {
        document.getElementById("cutoffModal").showModal();
      };

      window.closeCutoffModal = function () {
        document.getElementById("cutoffModal").close();
      };

      // Expose deductions modal functions globally
      window.openDeductionsModal = function () {
        // Load current deduction rates before opening modal
        if (window.loadDeductionRatesIntoModal) {
          window.loadDeductionRatesIntoModal();
        }
        document.getElementById("deductionsModal").showModal();
      };

      window.closeDeductionsModal = function () {
        document.getElementById("deductionsModal").close();
      };
    </script>

    <!-- Scripts -->
    <script type="module" src="../js/layout/sidebar.js"></script>
    <script src="../js/libs/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="../js/supabase/supabaseClient.js"></script>
    <script type="module" src="../js/settings/company-details.js"></script>
    <script type="module" src="../js/settings/main.js"></script>
  </body>
</html>
