<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Nexus Payroll</title>
    <link rel="stylesheet" href="../output.css" />
  </head>
  <body class="flex min-h-screen">
    <!-- Sidebar placeholder -->
    <div id="sidebar"></div>

    <!-- Main content -->
    <main class="flex-1 p-6">
      <!-- Logo -->
      <div class="flex items-center justify-center">
        <img src="../assets/npayroll_logo.png" alt="" class="w-20 h-20 mr-5" />
        <h3 class="text-3xl">Nexus Payroll</h3>
      </div>

      <!-- Time In/Out Button -->
      <div class="flex items-center justify-center mt-60">
        <button
          class="btn btn-outline btn-primary text-3xl w-150 h-20 rounded-4xl"
          onclick="cameraModal.showModal()"
        >
          Time In/Out
        </button>
      </div>

      <!-- Camera Modal -->
      <dialog id="cameraModal" class="modal">
        <div class="modal-box max-w-3xl">
          <form method="dialog">
            <button
              class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
            >
              âœ•
            </button>
          </form>

          <h3 class="text-lg font-bold mb-3">Facial Recognition Time In/Out</h3>

          <div class="flex flex-col md:flex-row gap-4">
            <!-- Camera -->
            <div class="flex-1 relative">
              <video
                id="video"
                autoplay
                muted
                playsinline
                class="w-full rounded-md border"
              ></video>
              <canvas
                id="overlay"
                class="absolute inset-0 pointer-events-none"
              ></canvas>
            </div>

            <!-- Status & controls -->
            <div class="w-full md:w-80">
              <div id="status" class="mb-4 p-3 rounded-md bg-base-200">
                Initializing...
              </div>

              <button id="startBtn" class="btn btn-primary w-full mb-2">
                Start Scanning
              </button>
              <button id="stopBtn" class="btn btn-outline w-full mb-2">
                Stop
              </button>

              <div class="mt-4 text-sm text-muted">
                <p>
                  Tip: Position your face inside the camera view. The system
                  will attempt to match your face and record time in/out
                  automatically.
                </p>
              </div>
            </div>
          </div>
        </div>
      </dialog>

      <!-- Confirmation Overlay -->
      <div
        id="confirmationOverlay"
        class="hidden fixed inset-0 bg-base-300 flex flex-col items-center justify-center text-center"
      >
        <div class="flex flex-col items-center space-y-2">
          <h3 id="confirmName" class="text-5xl font-semibold mt-4">
            Juan Dela Cruz
          </h3>
          <p id="confirmEmpId" class="text-2xl">0101010011011</p>
          <p
            id="confirmAction"
            class="text-5xl font-bold mt-6 mb-2 text-green-600"
          >
            IN
          </p>
          <p id="confirmTime" class="text-2xl">8:43 AM</p>
        </div>
      </div>
    </main>

    <script src="../js/layout/sidebar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
      import * as faceapi from "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.5.7/dist/face-api.esm.js";
      import { supabaseClient as supabase } from "../js/supabase/supabaseClient.js";

      // UI elements
      const cameraModal = document.getElementById("cameraModal");
      const video = document.getElementById("video");
      const overlay = document.getElementById("overlay");
      const statusEl = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");

      // confirmation overlay elements
      const confirmationOverlay = document.getElementById(
        "confirmationOverlay"
      );
      const confirmName = document.getElementById("confirmName");
      const confirmEmpId = document.getElementById("confirmEmpId");
      const confirmAction = document.getElementById("confirmAction");
      const confirmTime = document.getElementById("confirmTime");

      const MATCH_THRESHOLD = 0.55;

      let stream = null;
      let running = false;

      // Load models
      async function loadModels() {
        statusEl.textContent = "Loading face models...";
        const MODEL_URL =
          "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.5.7/model/";
        await faceapi.tf.setBackend("webgl");
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        statusEl.textContent = "Models loaded.";
      }

      // Start camera
      async function startCamera() {
        if (stream) return;
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user" },
            audio: false,
          });
          video.srcObject = stream;
          await video.play();
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Camera access denied or unavailable.";
        }
      }

      // Stop camera
      function stopCamera() {
        running = false;
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
        }
      }

      // Compute face descriptor
      async function computeDescriptor() {
        const detection = await faceapi
          .detectSingleFace(video)
          .withFaceLandmarks()
          .withFaceDescriptor();
        if (!detection) return null;
        return detection.descriptor;
      }

      // Find nearest employee from Supabase RPC
      async function findNearestEmployee(descriptor) {
        const arr = Array.from(descriptor);
        const { data, error } = await supabase.rpc("match_employee", {
          query: arr,
        });
        if (error) {
          console.error("RPC error", error);
          return null;
        }
        return data && data.length ? data[0] : null;
      }

      // Show confirmation overlay
      async function showConfirmation(name, empId, action) {
        confirmName.textContent = name;
        confirmEmpId.textContent = empId;
        confirmAction.textContent = action;
        confirmAction.classList.toggle("text-green-600", action === "TIME IN");
        confirmAction.classList.toggle("text-red-600", action === "TIME OUT");
        confirmTime.textContent = new Date().toLocaleTimeString();

        confirmationOverlay.classList.remove("hidden");
        cameraModal.close();
        stopCamera();

        setTimeout(() => {
          confirmationOverlay.classList.add("hidden");
        }, 5000);
      }

      // Handle time log
      async function handleTimeLog(emp_id, full_name) {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        const todayEnd = new Date();
        todayEnd.setHours(23, 59, 59, 999);

        const { data: openLogs, error: selErr } = await supabase
          .from("raw_time_logs")
          .select("*")
          .eq("emp_id", emp_id)
          .is("time_out", null)
          .gte("time_in", todayStart.toISOString())
          .lte("time_in", todayEnd.toISOString())
          .limit(1);

        if (selErr) {
          console.error(selErr);
          statusEl.textContent = "Database error.";
          return;
        }

        if (openLogs && openLogs.length) {
          const log = openLogs[0];
          const { error: updErr } = await supabase
            .from("raw_time_logs")
            .update({ time_out: new Date().toISOString() })
            .eq("time_log_id", log.time_log_id);
          if (updErr) {
            console.error(updErr);
            statusEl.textContent = "Failed to record time out.";
          } else {
            showConfirmation(full_name, emp_id, "TIME OUT");
          }
        } else {
          const { error: insErr } = await supabase
            .from("raw_time_logs")
            .insert({
              emp_id,
              official_time_id: 1,
              time_in: new Date().toISOString(),
              status: "present",
            });
          if (insErr) {
            console.error(insErr);
            statusEl.textContent = "Failed to record time in.";
          } else {
            showConfirmation(full_name, emp_id, "TIME IN");
          }
        }
      }

      // Recognition loop
      async function recognitionLoop() {
        running = true;
        statusEl.textContent = "Scanning...";
        while (running) {
          const descriptor = await computeDescriptor();
          if (descriptor) {
            const nearest = await findNearestEmployee(descriptor);
            if (nearest) {
              const distance = nearest.distance;
              if (distance <= 0.55) {
                await handleTimeLog(nearest.emp_id, nearest.full_name);
                running = false;
              } else {
                statusEl.textContent = `Face detected but not matched (${distance.toFixed(
                  3
                )}).`;
              }
            } else {
              statusEl.textContent = "No employee match.";
            }
          } else {
            statusEl.textContent = "No face detected.";
          }
          await new Promise((r) => setTimeout(r, 800));
        }
        statusEl.textContent = "Scanner stopped.";
      }

      // UI bindings
      startBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        await loadModels();
        await startCamera();
        recognitionLoop();
      });

      stopBtn.addEventListener("click", (e) => {
        e.preventDefault();
        stopCamera();
      });

      document
        .querySelector('button[onclick="cameraModal.showModal()"]')
        .addEventListener("click", () => {
          cameraModal.showModal();
          statusEl.textContent = "Open the scanner to begin.";
        });
    </script>
  </body>
</html>
