<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management | Nexus Payroll</title>
    <link rel="stylesheet" href="../output.css" />
    <link rel="stylesheet" href="../output.css" />
    <link rel="stylesheet" href="../css//ag-grid/ag-theme-quartz.css" />
  </head>
  <body class="flex">
    <!-- Global Alert Container -->
    <div
      id="globalAlert"
      class="fixed top-4 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-[999999] pointer-events-none"
    ></div>

    <!-- Sidebar placeholder -->
    <div id="sidebar"></div>

    <!-- Main content -->
    <main class="flex-1 p-6">
      <h1 class="text-3xl font-medium">User Management</h1>

      <!-- Search and Add New Button Div -->
      <div class="mt-5 flex w-full items-center justify-between">
        <!-- Search Bar -->
        <label
          class="input border border-accent focus-within:border-accent focus-within:ring-0 focus-within:outline-none shadow-none"
        >
          <svg
            class="h-[1em] opacity-50"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
          >
            <g
              stroke-linejoin="round"
              stroke-linecap="round"
              stroke-width="2.5"
              fill="none"
              stroke="currentColor"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </g>
          </svg>

          <input
            id="searchBar"
            type="search"
            required
            placeholder="Search"
            class="bg-transparent focus:outline-none"
          />
        </label>

        <!-- Add New Button-->
        <div class="flex flex-row items-center">
          <button
            class="btn btn-primary btn-md"
            onclick="addNewModal.showModal()"
          >
            Add New
          </button>
        </div>
      </div>

      <!-- AG Grid Div -->
      <div id="usersGrid" class="mt-5 h-[470px] w-full"></div>

      <!-- Generate CSV Div -->
      <div class="flex justify-end mt-5">
        <button class="btn btn-secondary btn-lg" onclick="genCSV.showModal()">
          Generate CSV
        </button>
      </div>
    </main>

    <dialog id="addNewModal" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
          >
            ✕
          </button>
        </form>
        <h3 class="text-lg font-bold">Add New User</h3>
        <br />

        <!-- Alerts -->
        <div id="dialogAlert" class="mt-5 mb-5"></div>

        <div class="flex justify-between items-center">
          <p>Username</p>
          <input id="usernameInput" type="text" class="input" />
        </div>

        <br />
        <div class="flex justify-between items-center">
          <p>Email</p>
          <input id="emailInput" type="text" class="input" />
        </div>

        <br />
        <div class="flex justify-between items-center">
          <p>Password</p>
          <input id="passwordInput" type="password" class="input" />
        </div>

        <br />
        <div class="flex justify-end">
          <button id="addUserBtn" class="btn btn-primary">
            <span
              class="loading loading-spinner hidden"
              id="loadingSpinner"
            ></span>
            <span id="btnText">Add User</span>
          </button>
        </div>
      </div>

      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Reset Dialog -->
    <dialog id="resetModal" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
          >
            ✕
          </button>
        </form>
        <h3 class="text-lg font-bold">Reset Password</h3>
        <br />

        <!-- Alerts -->
        <div id="dialogAlert" class="mt-5 mb-5"></div>

        <div class="flex justify-between items-center">
          <p>New Password</p>
          <input id="newPass" type="text" class="input" />
        </div>

        <br />
        <div class="flex justify-between items-center">
          <p>Confirm Password</p>
          <input id="confirmPass" type="text" class="input" />
        </div>

        <br />
        <div class="flex justify-end">
          <button id="resetPassBtn" class="btn btn-primary">
            <span
              class="loading loading-spinner hidden"
              id="loadingSpinner"
            ></span>
            <span id="btnText">Reset Password</span>
          </button>
        </div>
      </div>

      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Delete Modal -->
    <dialog id="deleteModal" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
          >
            ✕
          </button>
        </form>
        <h3 class="text-lg font-bold">Delete User</h3>
        <p class="py-4">
          Are you sure you want to delete this user? This action cannot be
          undone.
        </p>
        <div class="flex justify-end">
          <form method="dialog">
            <button class="btn">Cancel</button>
          </form>

          <button class="btn btn-error">Delete</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <script src="../js/layout/sidebar.js"></script>
    <script src="../js/libs/ag-grid-community.min.js"></script>

    <script type="module">
      import { supabaseClient } from "../js/supabase/supabaseClient.js";

      const gridDiv = document.getElementById("usersGrid");

      // Determine user theme preference
      const isDarkMode = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      gridDiv.classList.add(
        isDarkMode ? "ag-theme-quartz-dark" : "ag-theme-quartz"
      );
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (e) => {
          gridDiv.classList.toggle("ag-theme-quartz-dark", e.matches);
          gridDiv.classList.toggle("ag-theme-quartz", !e.matches);
        });

      // Define columns
      const columnDefs = [
        { headerName: "Status", field: "status", sortable: true, width: 120 },
        {
          headerName: "Actions",
          field: "actions",
          cellRenderer: function () {
            return `
          <button class="btn btn-sm btn-primary" onclick="resetModal.showModal()">Reset</button>
          <button class="btn btn-sm btn-error ml-1" onclick="deleteModal.showModal()">Delete</button>
        `;
          },
          width: 200,
          sortable: false,
          filter: false,
        },
        { headerName: "Username", field: "username", sortable: true, flex: 1 },
        { headerName: "Email", field: "email", sortable: true, flex: 1.5 },
        {
          headerName: "Created At",
          field: "created_at",
          sortable: true,
          width: 160,
        },
        {
          headerName: "Updated At",
          field: "updated_at",
          sortable: true,
          width: 160,
        },
      ];

      // Grid options
      const gridOptions = {
        columnDefs,
        rowData: [],
        rowSelection: "multiple",
        animateRows: true,
        defaultColDef: {
          filter: true,
          sortable: true,
          resizable: true,
        },
        pagination: true,
        paginationPageSize: 5,
        suppressRowClickSelection: true,
      };

      // Initialize AG Grid and keep reference to the grid instance
      const gridApi = agGrid.createGrid(gridDiv, gridOptions);

      // Fetch users from Supabase
      async function fetchUsers() {
        try {
          const { data, error } = await supabaseClient
            .from("users")
            .select("username, user_id, status, created_at, updated_at");

          if (error) throw error;

          const users = data.map((user) => ({
            username: user.username,
            email: "(auth linked)", // placeholder (can be replaced with real email)
            status: user.status,
            created_at: new Date(user.created_at).toLocaleDateString(),
            updated_at: user.updated_at
              ? new Date(user.updated_at).toLocaleDateString()
              : "-",
          }));

          gridApi.setGridOption("rowData", users);
        } catch (err) {
          console.error("Error fetching users:", err);
          alert("Failed to load users");
        }
      }

      document.addEventListener("DOMContentLoaded", fetchUsers);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
      import { supabaseClient } from "../js/supabase/supabaseClient.js";

      const modal = document.getElementById("addNewModal");
      const addUserBtn = modal.querySelector("#addUserBtn");
      const usernameInput = modal.querySelector("#usernameInput");
      const emailInput = modal.querySelector("#emailInput");
      const passwordInput = modal.querySelector("#passwordInput");
      const spinner = modal.querySelector("#loadingSpinner");
      const btnText = modal.querySelector("#btnText");
      const globalAlert = document.getElementById("globalAlert");
      const dialogAlert = document.getElementById("dialogAlert");

      // Show alert inside modal (for errors)
      function showDialogAlert(type, message) {
        const colorClass = type === "success" ? "alert-success" : "alert-error";
        dialogAlert.innerHTML = `
      <div class="alert ${colorClass} shadow-lg animate-fade-down">
        <span class="font-medium">${message}</span>
      </div>
    `;
        setTimeout(() => (dialogAlert.innerHTML = ""), 4000);
      }

      // Show global alert (for success)
      function showGlobalAlert(type, message) {
        const colorClass = type === "success" ? "alert-success" : "alert-error";
        globalAlert.innerHTML = `
      <div class="alert ${colorClass} shadow-lg animate-fade-down">
        <span class="font-medium">${message}</span>
      </div>
    `;
        setTimeout(() => (globalAlert.innerHTML = ""), 4000);
      }

      addUserBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        const username = usernameInput.value.trim();
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username || !email || !password) {
          showDialogAlert("error", "Please fill out all fields.");
          return;
        }

        spinner.classList.remove("hidden");
        btnText.textContent = "Creating...";
        addUserBtn.disabled = true;

        try {
          // 1. Create user in Supabase Auth
          const { data: signUpData, error: signUpError } =
            await supabaseClient.auth.signUp({ email, password });

          if (signUpError) throw signUpError;

          const userId = signUpData.user?.id;
          if (!userId)
            throw new Error("User creation failed — no user ID returned.");

          // 2. Insert into custom 'users' table with email included
          const { error: insertError } = await supabaseClient
            .from("users")
            .insert([{ user_id: userId, username, email }]);

          if (insertError) throw insertError;

          // 3. Success message (global)
          showGlobalAlert("success", "User successfully added!");

          // 4. Clear fields
          usernameInput.value = "";
          emailInput.value = "";
          passwordInput.value = "";

          // 5. Close modal after short delay
          setTimeout(() => modal.close(), 1500);
        } catch (error) {
          console.error("Error adding user:", error);
          showDialogAlert("error", error.message);
        } finally {
          spinner.classList.add("hidden");
          btnText.textContent = "Add User";
          addUserBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
