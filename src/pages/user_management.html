<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management | Nexus Payroll</title>
    <link rel="stylesheet" href="../output.css" />
    <link rel="stylesheet" href="../output.css" />
    <link rel="stylesheet" href="../css//ag-grid/ag-theme-quartz.css" />
  </head>
  <body class="flex">
    <!-- Global Alert Container -->
    <div
      id="globalAlert"
      class="fixed top-4 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-[999999] pointer-events-none"
    ></div>

    <!-- Sidebar placeholder -->
    <div id="sidebar"></div>

    <!-- Main content -->
    <main class="flex-1 p-6">
      <h1 class="text-3xl font-medium">User Management</h1>

      <!-- Search and Add New Button Div -->
      <div class="mt-5 flex w-full items-center justify-between">
        <!-- Search Bar -->
        <label
          class="input border border-accent focus-within:border-accent focus-within:ring-0 focus-within:outline-none shadow-none"
        >
          <svg
            class="h-[1em] opacity-50"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
          >
            <g
              stroke-linejoin="round"
              stroke-linecap="round"
              stroke-width="2.5"
              fill="none"
              stroke="currentColor"
            >
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </g>
          </svg>

          <input
            id="searchBar"
            type="search"
            required
            placeholder="Search"
            class="bg-transparent focus:outline-none"
          />
        </label>

        <!-- Add New Button-->
        <div class="flex flex-row items-center">
          <button
            class="btn btn-primary btn-md"
            onclick="addNewModal.showModal()"
          >
            Add New
          </button>
        </div>
      </div>

      <!-- AG Grid Div -->
      <div id="usersGrid" class="mt-5 h-[470px] w-full"></div>

      <!-- Generate CSV Div -->
      <div class="flex justify-end mt-5">
        <button class="btn btn-secondary btn-lg" onclick="genCSV.showModal()">
          Generate CSV
        </button>
      </div>
    </main>

    <dialog id="addNewModal" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
          >
            ✕
          </button>
        </form>
        <h3 class="text-lg font-bold">Add New User</h3>
        <br />

        <!-- Alerts -->
        <div id="dialogAlert" class="mt-5 mb-5"></div>

        <div class="flex justify-between items-center">
          <p>Username</p>
          <input id="usernameInput" type="text" class="input" />
        </div>

        <br />
        <div class="flex justify-between items-center">
          <p>Email</p>
          <input id="emailInput" type="text" class="input" />
        </div>

        <br />
        <div class="flex justify-between items-center">
          <p>Password</p>
          <input id="passwordInput" type="password" class="input" />
        </div>

        <br />
        <div class="flex justify-end">
          <button id="addUserBtn" class="btn btn-primary">
            <span
              class="loading loading-spinner hidden"
              id="loadingSpinner"
            ></span>
            <span id="btnText">Add User</span>
          </button>
        </div>
      </div>

      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Reset Dialog -->
    <dialog id="resetModal" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
          >
            ✕
          </button>
        </form>
        <h3 class="text-lg font-bold">Reset Password</h3>
        <br />

        <!-- Alerts -->
        <div id="dialogResetAlert" class="mt-5 mb-5"></div>

        <div class="flex justify-between items-center">
          <p>New Password</p>
          <input id="newPass" type="text" class="input" />
        </div>

        <br />
        <div class="flex justify-between items-center">
          <p>Confirm Password</p>
          <input id="confirmPass" type="text" class="input" />
        </div>

        <br />
        <div class="flex justify-end">
          <button id="resetPassBtn" class="btn btn-primary">
            <span
              class="loading loading-spinner hidden"
              id="loadingSpinnerReset"
            ></span>
            <span id="btnTextReset">Reset Password</span>
          </button>
        </div>
      </div>

      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Generate CSV Modal -->
    <dialog id="genCSV" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
          >
            ✕
          </button>
        </form>
        <h3 class="text-lg font-bold">Generate CSV Export</h3>
        <p class="py-4">
          This will export all user data (username, email, status, created date,
          and updated date) to a CSV file.
        </p>

        <div id="csvAlert" class="mt-3 mb-3"></div>

        <div class="flex justify-end gap-2">
          <form method="dialog">
            <button class="btn">Cancel</button>
          </form>
          <button id="downloadCSVBtn" class="btn btn-secondary">
            <span class="loading loading-spinner hidden" id="csvSpinner"></span>
            <span id="csvBtnText">Download CSV</span>
          </button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Delete Modal -->
    <dialog id="deleteModal" class="modal">
      <div class="modal-box">
        <form method="dialog">
          <button
            class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
          >
            ✕
          </button>
        </form>
        <h3 class="text-lg font-bold">Delete User</h3>
        <p class="py-4">
          Are you sure you want to delete this user? This action cannot be
          undone.
        </p>
        <div class="flex justify-end">
          <form method="dialog">
            <button class="btn">Cancel</button>
          </form>

          <button class="btn btn-error">Delete</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <script src="../js/layout/sidebar.js"></script>
    <script src="../js/libs/ag-grid-community.min.js"></script>

    <script>
      // Global alert function
      window.showGlobalAlert = function (type, message) {
        const globalAlert = document.getElementById("globalAlert");
        const colorClass = type === "success" ? "alert-success" : "alert-error";
        globalAlert.innerHTML = `
          <div class="alert ${colorClass} shadow-lg animate-fade-down">
            <span class="font-medium">${message}</span>
          </div>
        `;
        setTimeout(() => (globalAlert.innerHTML = ""), 4000);
      };
    </script>

    <script type="module">
      import { supabaseAdmin } from "../js/supabase/adminClient.js";
      import { supabaseClient } from "../js/supabase/supabaseClient.js";

      const gridDiv = document.getElementById("usersGrid");

      // Determine user theme preference
      const isDarkMode = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      gridDiv.classList.add(
        isDarkMode ? "ag-theme-quartz-dark" : "ag-theme-quartz"
      );
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", (e) => {
          gridDiv.classList.toggle("ag-theme-quartz-dark", e.matches);
          gridDiv.classList.toggle("ag-theme-quartz", !e.matches);
        });

      // Define columns
      const columnDefs = [
        {
          headerName: "Status",
          field: "status",
          sortable: true,
          width: 150,
          editable: true,
          cellEditor: "agSelectCellEditor",
          cellEditorParams: {
            values: ["active", "inactive"],
          },
          cellStyle: (params) => ({
            color: params.value === "active" ? "#38B000" : "gray",
            fontWeight: "500",
          }),
        },

        {
          headerName: "Actions",
          field: "actions",
          cellRenderer: function (params) {
            const email = params.data.email;
            return `
            <button class="btn btn-sm btn-primary" onclick="openResetModal('${email}')">Reset</button>
          `;
          },
          width: 100,
          sortable: false,
          filter: false,
        },

        {
          headerName: "Username",
          field: "username",
          sortable: true,
          flex: 1,
          editable: true,
        },
        {
          headerName: "Email",
          field: "email",
          sortable: true,
          flex: 1.5,
          editable: true,
        },
        {
          headerName: "Created At",
          field: "created_at",
          sortable: true,
          width: 180,
        },
        {
          headerName: "Updated At",
          field: "updated_at",
          sortable: true,
          width: 180,
        },
      ];

      // Grid options
      const gridOptions = {
        columnDefs,
        rowData: [],
        rowSelection: "multiple",
        animateRows: true,
        defaultColDef: {
          filter: true,
          sortable: true,
          resizable: true,
        },
        pagination: true,
        paginationPageSize: 5,
        suppressRowClickSelection: true,

        onCellEditingStopped: async (event) => {
          const field = event.colDef.field;
          const email = event.data.email;
          const newValue = event.value;
          const oldValue = event.oldValue;

          if (!email || newValue === oldValue) return;

          if (field === "status") {
            try {
              const { error } = await supabaseAdmin
                .from("users")
                .update({
                  status: newValue,
                  updated_at: new Date().toISOString(),
                })
                .eq("email", email);

              if (error) throw error;

              event.data.updated_at = new Date().toLocaleString();

              event.api.refreshCells({
                rowNodes: [event.node],
                columns: ["updated_at"],
                force: true,
              });

              window.showGlobalAlert(
                "success",
                `Status for ${event.data.username} updated to "${newValue}"`
              );
            } catch (err) {
              console.error("Error updating status:", err);

              event.data.status = oldValue;

              event.api.refreshCells({
                rowNodes: [event.node],
                columns: ["status"],
                force: true,
              });

              window.showGlobalAlert(
                "error",
                `Failed to update status: ${err.message}`
              );
            }
          } else if (field === "username") {
            try {
              const { error } = await supabaseAdmin
                .from("users")
                .update({
                  username: newValue,
                  updated_at: new Date().toISOString(),
                })
                .eq("email", email);

              if (error) throw error;

              event.data.updated_at = new Date().toLocaleString();

              event.api.refreshCells({
                rowNodes: [event.node],
                columns: ["updated_at"],
                force: true,
              });

              window.showGlobalAlert(
                "success",
                `Username updated to "${newValue}"`
              );
            } catch (err) {
              console.error("Error updating username:", err);

              event.data.username = oldValue;

              event.api.refreshCells({
                rowNodes: [event.node],
                columns: ["username"],
                force: true,
              });

              window.showGlobalAlert(
                "error",
                `Failed to update username: ${err.message}`
              );
            }
          } else if (field === "email") {
            try {
              // Update email in the database using the OLD email as the identifier
              const { error } = await supabaseAdmin
                .from("users")
                .update({
                  email: newValue,
                  updated_at: new Date().toISOString(),
                })
                .eq("email", oldValue);

              if (error) throw error;

              event.data.updated_at = new Date().toLocaleString();

              event.api.refreshCells({
                rowNodes: [event.node],
                columns: ["updated_at"],
                force: true,
              });

              window.showGlobalAlert(
                "success",
                `Email updated to "${newValue}"`
              );
            } catch (err) {
              console.error("Error updating email:", err);

              event.data.email = oldValue;

              event.api.refreshCells({
                rowNodes: [event.node],
                columns: ["email"],
                force: true,
              });

              window.showGlobalAlert(
                "error",
                `Failed to update email: ${err.message}`
              );
            }
          }
        },
      };

      // Initialize AG Grid
      const gridApi = agGrid.createGrid(gridDiv, gridOptions);

      // Fetch users from Supabase
      async function fetchUsers() {
        try {
          const { data, error } = await supabaseClient
            .from("users")
            .select("username, email, status, created_at, updated_at")
            .order("created_at", { ascending: false });

          if (error) throw error;

          // Format and map data
          const users = data.map((user) => ({
            username: user.username,
            email: user.email,
            status: user.status || "inactive",
            created_at: new Date(user.created_at).toLocaleString(),
            updated_at: user.updated_at
              ? new Date(user.updated_at).toLocaleString()
              : "-",
          }));

          gridApi.setGridOption("rowData", users);
        } catch (err) {
          console.error("Error fetching users:", err);
          alert("Failed to load users");
        }
      }

      document.addEventListener("DOMContentLoaded", fetchUsers);

      // Make gridApi globally accessible for CSV export
      window.gridApi = gridApi;

      // Search functionality
      const searchBar = document.getElementById("searchBar");
      searchBar.addEventListener("input", (e) => {
        const searchValue = e.target.value.toLowerCase();
        gridApi.setGridOption("quickFilterText", searchValue);
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
      import { supabaseClient } from "../js/supabase/supabaseClient.js";

      const modal = document.getElementById("addNewModal");
      const addUserBtn = modal.querySelector("#addUserBtn");
      const usernameInput = modal.querySelector("#usernameInput");
      const emailInput = modal.querySelector("#emailInput");
      const passwordInput = modal.querySelector("#passwordInput");
      const spinner = modal.querySelector("#loadingSpinner");
      const btnText = modal.querySelector("#btnText");
      const dialogAlert = document.getElementById("dialogAlert");

      function showDialogAlert(type, message) {
        const colorClass = type === "success" ? "alert-success" : "alert-error";
        dialogAlert.innerHTML = `
      <div class="alert ${colorClass} shadow-lg animate-fade-down">
        <span class="font-medium">${message}</span>
      </div>
    `;
        setTimeout(() => (dialogAlert.innerHTML = ""), 4000);
      }

      addUserBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        const username = usernameInput.value.trim();
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!username || !email || !password) {
          showDialogAlert("error", "Please fill out all fields.");
          return;
        }

        spinner.classList.remove("hidden");
        btnText.textContent = "Creating...";
        addUserBtn.disabled = true;

        try {
          const { data: signUpData, error: signUpError } =
            await supabaseClient.auth.signUp({ email, password });

          if (signUpError) throw signUpError;

          const userId = signUpData.user?.id;
          if (!userId)
            throw new Error("User creation failed — no user ID returned.");

          const { error: insertError } = await supabaseClient
            .from("users")
            .insert([{ user_id: userId, username, email }]);

          if (insertError) throw insertError;

          window.showGlobalAlert("success", "User successfully added!");

          usernameInput.value = "";
          emailInput.value = "";
          passwordInput.value = "";

          setTimeout(() => modal.close(), 1500);
        } catch (error) {
          console.error("Error adding user:", error);
          showDialogAlert("error", error.message);
        } finally {
          spinner.classList.add("hidden");
          btnText.textContent = "Add User";
          addUserBtn.disabled = false;
        }
      });
    </script>

    <script type="module">
      import { supabaseAdmin } from "../js/supabase/adminClient.js";

      const resetModal = document.getElementById("resetModal");
      const resetPassBtn = resetModal.querySelector("#resetPassBtn");
      const newPassInput = resetModal.querySelector("#newPass");
      const confirmPassInput = resetModal.querySelector("#confirmPass");
      const resetDialogAlert = document.getElementById("dialogResetAlert");

      let currentUserEmail = null;

      window.openResetModal = (email) => {
        currentUserEmail = email;
        resetModal.showModal();
      };

      function showDialogAlert(type, message) {
        const colorClass = type === "success" ? "alert-success" : "alert-error";
        resetDialogAlert.innerHTML = `
    <div class="alert ${colorClass} shadow-lg animate-fade-down">
      <span class="font-medium">${message}</span>
    </div>
  `;
        setTimeout(() => (resetDialogAlert.innerHTML = ""), 4000);
      }

      resetPassBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        const newPass = newPassInput.value.trim();
        const confirmPass = confirmPassInput.value.trim();

        if (!newPass || !confirmPass) {
          showDialogAlert("error", "Please fill in both fields.");
          return;
        }
        if (newPass !== confirmPass) {
          showDialogAlert("error", "Passwords do not match.");
          return;
        }

        try {
          const { data: listData, error: listError } =
            await supabaseAdmin.auth.admin.listUsers();
          if (listError) throw listError;

          const user = listData.users.find((u) => u.email === currentUserEmail);
          if (!user) throw new Error("User not found");

          const { data: updateData, error: updateError } =
            await supabaseAdmin.auth.admin.updateUserById(user.id, {
              password: newPass,
            });

          if (updateError) throw updateError;

          const { error: timeUpdateError } = await supabaseAdmin
            .from("users")
            .update({ updated_at: new Date().toISOString() })
            .eq("email", currentUserEmail);

          if (timeUpdateError) throw timeUpdateError;

          showDialogAlert("success", "Password successfully reset!");
          setTimeout(() => resetModal.close(), 1500);
        } catch (err) {
          console.error("Error resetting password:", err);
          showDialogAlert("error", err.message);
        }
      });
    </script>

    <!-- CSV Export Functionality -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const downloadCSVBtn = document.getElementById("downloadCSVBtn");
        const csvSpinner = document.getElementById("csvSpinner");
        const csvBtnText = document.getElementById("csvBtnText");
        const csvAlert = document.getElementById("csvAlert");
        const genCSVModal = document.getElementById("genCSV");

        function showCSVAlert(type, message) {
          const colorClass =
            type === "success" ? "alert-success" : "alert-error";
          csvAlert.innerHTML = `
            <div class="alert ${colorClass} shadow-lg animate-fade-down">
              <span class="font-medium">${message}</span>
            </div>
          `;
          setTimeout(() => (csvAlert.innerHTML = ""), 4000);
        }

        function escapeCSVValue(value) {
          if (value === null || value === undefined) return "";
          const str = String(value);
          if (str.includes(",") || str.includes('"') || str.includes("\n")) {
            return `"${str.replace(/"/g, '""')}"`;
          }
          return str;
        }

        downloadCSVBtn.addEventListener("click", () => {
          try {
            csvSpinner.classList.remove("hidden");
            csvBtnText.textContent = "Generating...";
            downloadCSVBtn.disabled = true;

            const rowData = [];
            window.gridApi.forEachNode((node) => rowData.push(node.data));

            if (rowData.length === 0) {
              showCSVAlert("error", "No data to export");
              return;
            }

            const headers = [
              "Username",
              "Email",
              "Status",
              "Created At",
              "Updated At",
            ];
            const csvRows = [headers.join(",")];

            rowData.forEach((row) => {
              const values = [
                escapeCSVValue(row.username),
                escapeCSVValue(row.email),
                escapeCSVValue(row.status),
                escapeCSVValue(row.created_at),
                escapeCSVValue(row.updated_at),
              ];
              csvRows.push(values.join(","));
            });

            const csvContent = csvRows.join("\n");
            const blob = new Blob([csvContent], {
              type: "text/csv;charset=utf-8;",
            });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);

            const timestamp = new Date()
              .toISOString()
              .slice(0, 19)
              .replace(/:/g, "-");
            link.setAttribute("href", url);
            link.setAttribute("download", `users_export_${timestamp}.csv`);
            link.style.visibility = "hidden";

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            window.showGlobalAlert(
              "success",
              "CSV file downloaded successfully!"
            );
            setTimeout(() => genCSVModal.close(), 1000);
          } catch (error) {
            console.error("Error generating CSV:", error);
            showCSVAlert("error", "Failed to generate CSV");
          } finally {
            csvSpinner.classList.add("hidden");
            csvBtnText.textContent = "Download CSV";
            downloadCSVBtn.disabled = false;
          }
        });
      });
    </script>
  </body>
</html>
